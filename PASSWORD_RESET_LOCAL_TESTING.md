# パスワードリセットのテスト方法（ローカル環境）

## 問題

ローカル環境でパスワードリセットメールのリンクをクリックすると、**デフォルトブラウザ**で開かれてしまい、開発中のブラウザとは異なるセッションになってしまいます。

## 解決方法

以下の3つの方法でテストできます。

---

## 方法1: メールリンクを手動でコピー（推奨）

### 手順

1. **パスワードリセットメールを送信**
   - ログイン画面で「パスワードを忘れた方」をクリック
   - メールアドレスを入力して「リセットメールを送信」

2. **メールを確認**
   - メールアプリでパスワードリセットメールを開く
   - 「Reset Password」ボタンを**右クリック**
   - 「リンクをコピー」を選択

3. **開発中のブラウザでリンクを開く**
   - 開発中のブラウザ（localhost:3000が開いているブラウザ）に戻る
   - アドレスバーにリンクを**貼り付け**
   - Enterキーを押す

4. **期待される動作**
   - トップページが表示される
   - ブラウザのコンソール（F12）を開く
   - 以下のようなログが表示される：
     ```
     🔍 初期化: URL詳細チェック { fullUrl: "...", hash: "#access_token=...&type=recovery", ... }
     🔐 パスワードリセットモードを検出しました
     🔐 パスワードリセットリンクを検出しました: { ... }
     ⏳ セッション確立を試みます...
     ✅ パスワードリセット: セッション確立成功、パスワード変更画面を表示
     🔔 認証状態変更: PASSWORD_RECOVERY user@example.com
     ```
   - **パスワード変更画面が自動的に表示される**

---

## 方法2: 同じブラウザで開く設定（Windows）

### Chrome/Edgeの場合

1. **デフォルトブラウザを変更**
   - Windowsの設定 → アプリ → 既定のアプリ
   - 開発中のブラウザ（ChromeまたはEdge）を既定のブラウザに設定

2. **パスワードリセットメールを送信**
   - 通常通り、メールのリンクをクリック

3. **期待される動作**
   - 既定のブラウザで開かれる
   - ただし、**新しいタブ**として開かれるため、セッションが共有される可能性がある

---

## 方法3: メールクライアントで直接URLを確認

### Gmail（ブラウザ版）の場合

1. **メールをブラウザで開く**
   - https://mail.google.com にアクセス
   - パスワードリセットメールを開く

2. **リンクをコピー**
   - 「Reset Password」ボタンを右クリック
   - 「リンクのアドレスをコピー」

3. **開発中のブラウザで開く**
   - localhost:3000が開いているタブのアドレスバーにリンクを貼り付け
   - Enterキーを押す

---

## デバッグ方法

### ブラウザのコンソールを開く

1. **F12キー**を押す
2. **Consoleタブ**を選択
3. 以下のログを確認：

#### 成功時のログ

```
🔍 初期化: URL詳細チェック
  fullUrl: "http://localhost:3000/#access_token=...&type=recovery"
  pathname: "/"
  search: ""
  hash: "#access_token=eyJhb...&type=recovery"
  token: null
  type: null
  isRecovery: true

🔐 パスワードリセットモードを検出しました
🔐 パスワードリセットリンクを検出しました: { hash: "#access_token=...", search: "" }
📍 現在のURL: http://localhost:3000/#access_token=...&type=recovery
⏳ セッション確立を試みます...
📊 パスワードリセット: セッション確認結果
  hasSession: true
  hasUser: true
  userEmail: "user@example.com"
  error: null
✅ パスワードリセット: セッション確立成功、パスワード変更画面を表示
🔔 認証状態変更: PASSWORD_RECOVERY user@example.com
👤 ユーザーセッション確立: user@example.com
```

#### 失敗時のログ

```
🔍 初期化: URL詳細チェック
  fullUrl: "http://localhost:3000/"
  pathname: "/"
  search: ""
  hash: ""
  token: null
  type: null
  isRecovery: false

// パスワードリセットモードが検出されていない
```

---

## トラブルシューティング

### 問題1: URLハッシュフラグメントが消えてしまう

**症状:**
- メールのリンクをクリックしても、URLに `#access_token=...` が含まれない
- コンソールに「パスワードリセットモードを検出しました」と表示されない

**原因:**
- ブラウザが新しいセッションで開かれたため、URLハッシュが失われた
- メールクライアントがリンクを変換してしまった

**解決方法:**
1. メールのリンクを**右クリック**して「リンクをコピー」
2. コピーしたリンクをテキストエディタに貼り付けて確認
3. `#access_token=...&type=recovery` が含まれているか確認
4. リンク全体を開発中のブラウザのアドレスバーに貼り付けて開く

---

### 問題2: パスワード変更画面が表示されない

**症状:**
- URLハッシュは正しく検出されている（コンソールログで確認済み）
- しかし、パスワード変更画面が表示されない

**確認項目:**

1. **コンソールログを確認**
   ```
   ✅ パスワードリセット: セッション確立成功、パスワード変更画面を表示
   ```
   このログが表示されているか？

2. **AuthModalが表示されているか確認**
   - ブラウザの開発者ツール → Elements タブ
   - `<div class="fixed inset-0 bg-black/60">` のような要素が存在するか

3. **z-indexの問題**
   - パスワード変更画面が他の要素の下に隠れている可能性
   - CSSを確認: `.z-[100]` などの設定

**解決方法:**
- ページをリロード（F5）
- ブラウザのキャッシュをクリア（Ctrl + Shift + Delete）
- ブラウザの拡張機能を無効化

---

### 問題3: メールが届かない

**症状:**
- 「リセットメールを送信」をクリックしても、メールが届かない

**確認項目:**

1. **Supabaseの設定確認**
   - Supabaseダッシュボード → Settings → Auth
   - SMTP設定が正しいか確認

2. **迷惑メールフォルダを確認**

3. **Supabaseのログを確認**
   - Supabaseダッシュボード → Logs
   - メール送信のログを確認

---

## ローカル環境でのテストの限界

### ローカル環境での問題点

1. **デフォルトブラウザの問題**
   - メールリンクは常にデフォルトブラウザで開かれる
   - 開発中のブラウザと異なる場合、セッションが共有されない

2. **URLハッシュの扱い**
   - 一部のメールクライアントはURLハッシュを正しく処理しない可能性がある

3. **CORS問題**
   - localhost と本番ドメインの違いにより、動作が異なる可能性がある

### 本番環境での動作確認が重要

ローカル環境でのテストには限界があります。以下を推奨します：

1. **Vercel/Netlifyなどにデプロイ**
   - プレビュー環境を作成
   - 本番に近い環境でテスト

2. **Supabaseの設定を確認**
   - Site URL: `https://shindan-quiz.makers.tokyo`
   - Redirect URLs: `https://shindan-quiz.makers.tokyo` を追加

3. **本番環境でのテスト**
   - 実際のメールアドレスでテスト
   - 実際のブラウザでメールを開いてリンクをクリック

---

## まとめ

### ローカル環境でのテスト方法

1. ✅ **方法1（推奨）**: メールリンクを手動でコピーして、開発中のブラウザに貼り付ける
2. ⚠️ **方法2**: デフォルトブラウザを開発中のブラウザに設定（セッションが共有されない可能性あり）
3. ✅ **方法3**: メールクライアントをブラウザで開いて、リンクをコピー

### デバッグのポイント

- **ブラウザのコンソール（F12）を常に開く**
- **詳細なログを確認**（絵文字アイコン付きで見やすくなっています）
- **URLハッシュフラグメントが正しく含まれているか確認**

### 本番環境でのテスト

ローカル環境でのテストには限界があるため、最終的には本番環境（または本番に近い環境）でテストすることを強く推奨します。

---

**作成日**: 2025年12月9日  
**バージョン**: 1.0

