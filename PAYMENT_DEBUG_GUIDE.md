# 決済後の機能開放デバッグガイド

## 問題の概要
決済完了後にHTMLダウンロードや埋め込み機能がアクティブにならない問題のデバッグ方法をまとめました。

## 実施した修正

### 1. Dashboard.jsx の改善
- **詳細なログ追加**: 各ステップでコンソールログを出力
- **URLパラメータのクリアタイミング調整**: 決済検証前にクリア
- **購入履歴の取得改善**: セッション情報の確認を追加
- **リロードタイミングの最適化**: `window.location.href`を使用して完全リロード

### 2. デバッグ機能の追加
- **購入履歴確認ボタン**: ダッシュボードに追加（開発用）
- **環境変数確認API**: `/api/debug-env`エンドポイント
- **SQLデバッグクエリ**: `debug_purchases.sql`ファイル

## デバッグ手順

### ステップ1: ブラウザコンソールでログを確認

1. ブラウザで F12 キーを押して開発者ツールを開く
2. Console タブを選択
3. 決済を実行して以下のログを確認:

```
🚀 Dashboard初期化開始 user.id: xxx
📋 URLパラメータ: { paymentStatus: 'success', sessionId: 'cs_xxx', quizId: '56' }
✅ 決済成功を検出！検証を開始します...
🔍 決済検証開始: { sessionId: 'cs_xxx', quizId: '56', userId: 'xxx' }
🧹 URLパラメータをクリアしました
✅ 決済検証レスポンス: { success: true, ... }
✅ 決済検証成功！購入履歴を更新します...
🔍 購入履歴を再取得します... user.id: xxx
📋 購入履歴を更新: [...]
📋 購入件数: 1
📋 購入済みクイズID: [56]
📋 今回購入したクイズ(56)が含まれている: true
🔄 ページをリロードします...
```

### ステップ2: サーバーログを確認

ターミナルで以下のログを確認:

```
🔍 決済検証リクエスト: { sessionId: 'cs_xxx', quizId: '56', userId: 'xxx' }
💳 Stripe決済ステータス: paid
📝 購入履歴を挿入: { user_id: 'xxx', quiz_id: 56, ... }
✅ 購入履歴を記録完了: [...]
🔍 購入履歴の確認: [...]
POST /api/verify 200 in XXXms
```

### ステップ3: 購入履歴確認ボタンを使用

1. ダッシュボードの「🔍 購入履歴確認」ボタンをクリック
2. アラートで購入件数を確認
3. コンソールで詳細なデータを確認

### ステップ4: 環境変数を確認

ブラウザで以下のURLにアクセス（開発環境のみ）:
```
http://localhost:3000/api/debug-env
```

以下の項目がすべて `true` であることを確認:
- `hasSupabaseUrl`
- `hasSupabaseAnonKey`
- `hasSupabaseServiceKey`
- `hasStripeSecretKey`

### ステップ5: Supabaseで直接確認

1. Supabaseダッシュボードを開く
2. SQL Editorを開く
3. `debug_purchases.sql`の内容を実行
4. 購入履歴が正しく記録されているか確認

## よくある問題と解決方法

### 問題1: `/api/verify`が呼ばれない
**症状**: ブラウザコンソールに「決済検証開始」のログが表示されない

**確認事項**:
- URLパラメータが正しく渡されているか
- ユーザーがログインしているか
- `useEffect`が実行されているか

**解決方法**:
```javascript
// URLパラメータを確認
console.log(window.location.search);
```

### 問題2: 購入履歴が取得できない
**症状**: 購入履歴の取得でエラーが発生

**確認事項**:
- Supabase RLSポリシーが正しく設定されているか
- ユーザーのセッションが有効か
- `user.id`が正しいか

**解決方法**:
1. `supabase_purchases_schema.sql`を再実行
2. ブラウザのキャッシュをクリア
3. ログアウト→ログインを試す

### 問題3: 購入履歴は取得できるが、UIが更新されない
**症状**: コンソールには購入履歴が表示されるが、ボタンがアクティブにならない

**確認事項**:
- `purchases`ステートが更新されているか
- `quiz.id`の型（数値 vs 文字列）
- リロードが実行されているか

**解決方法**:
```javascript
// クイズカードのログを確認
console.log(`🔓 Quiz ${quiz.id}:`, {
    isUnlocked,
    isPurchased: purchases.includes(quiz.id),
    purchases
});
```

### 問題4: SUPABASE_SERVICE_ROLE_KEYが設定されていない
**症状**: `/api/verify`で購入履歴の挿入に失敗

**解決方法**:
1. `.env.local`ファイルを確認
2. `SUPABASE_SERVICE_ROLE_KEY`が設定されているか確認
3. Vercelの環境変数も確認（本番環境の場合）

## テスト用Stripeカード番号

開発環境でテストする場合:
- カード番号: `4242 4242 4242 4242`
- 有効期限: 未来の日付（例: 12/34）
- CVC: 任意の3桁（例: 123）
- 郵便番号: 任意

## チェックリスト

決済機能が正しく動作するための確認項目:

- [ ] 環境変数がすべて設定されている
- [ ] Supabase RLSポリシーが正しく設定されている
- [ ] Stripe APIキーが正しい（テスト/本番）
- [ ] ユーザーがログインしている
- [ ] ブラウザコンソールにエラーがない
- [ ] サーバーログにエラーがない
- [ ] 購入履歴がデータベースに記録されている
- [ ] 購入履歴が正しく取得できる
- [ ] UIが正しく更新される

## サポート

問題が解決しない場合は、以下の情報を収集してください:

1. ブラウザコンソールのログ（スクリーンショット）
2. サーバーログ（ターミナル出力）
3. Supabaseの購入履歴テーブルの内容
4. 環境変数の設定状況（`/api/debug-env`の出力）
5. エラーメッセージの全文

## 本番環境へのデプロイ前の注意

本番環境にデプロイする前に、以下のデバッグ機能を無効化してください:

1. **購入履歴確認ボタン**: Dashboard.jsxから削除
2. **デバッグ用コンソールログ**: 本番環境では最小限に
3. **環境変数確認API**: `/api/debug-env`を削除または無効化

```javascript
// 本番環境でのログ出力を制御
const isDev = process.env.NODE_ENV === 'development';
if (isDev) {
  console.log('デバッグ情報...');
}
```

